# External Secrets Operator Configuration for DMARC Dashboard
# Integrates with external secret management systems (AWS Secrets Manager, HashiCorp Vault, etc.)
# Prerequisites: External Secrets Operator must be installed
# Install: https://external-secrets.io/latest/introduction/getting-started/
---
# SecretStore for AWS Secrets Manager
# Configure this to connect to your AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: dmarc
  labels:
    app.kubernetes.io/name: dmarc-dashboard
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1  # UPDATE THIS

      # Authentication using IAM role (recommended for EKS)
      auth:
        jwt:
          serviceAccountRef:
            name: dmarc-backend-sa

      # Alternative: Use static credentials (not recommended)
      # auth:
      #   secretRef:
      #     accessKeyIDSecretRef:
      #       name: aws-credentials
      #       key: access-key-id
      #     secretAccessKeySecretRef:
      #       name: aws-credentials
      #       key: secret-access-key
---
# ClusterSecretStore for AWS Secrets Manager (cluster-wide)
# Use this if secrets are shared across namespaces
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager-cluster
  labels:
    app.kubernetes.io/name: dmarc-dashboard
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1  # UPDATE THIS
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets-system
---
# SecretStore for HashiCorp Vault
# Configure this if using Vault
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: dmarc
  labels:
    app.kubernetes.io/name: dmarc-dashboard
spec:
  provider:
    vault:
      server: "https://vault.example.com"  # UPDATE THIS
      path: "secret"
      version: "v2"

      # Kubernetes auth
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "dmarc-role"
          serviceAccountRef:
            name: dmarc-backend-sa

      # Alternative: Token auth
      # auth:
      #   tokenSecretRef:
      #     name: vault-token
      #     key: token
---
# SecretStore for Google Cloud Secret Manager
# Configure this if using GCP
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcp-secrets-manager
  namespace: dmarc
  labels:
    app.kubernetes.io/name: dmarc-dashboard
spec:
  provider:
    gcpsm:
      projectID: "your-project-id"  # UPDATE THIS

      # Workload Identity (recommended for GKE)
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: your-cluster-name
          serviceAccountRef:
            name: dmarc-backend-sa

      # Alternative: Service Account Key
      # auth:
      #   secretRef:
      #     secretAccessKeySecretRef:
      #       name: gcp-credentials
      #       key: service-account-key.json
---
# ExternalSecret for Database Credentials
# Syncs database credentials from external secret manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: dmarc-database-credentials
  namespace: dmarc
  labels:
    app.kubernetes.io/name: dmarc-dashboard
    app.kubernetes.io/component: database
spec:
  # Refresh interval
  refreshInterval: 1h

  # SecretStore reference
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore

  # Target Kubernetes secret
  target:
    name: dmarc-db-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Template for DATABASE_URL
        DATABASE_URL: "postgresql://{{ .DB_USER }}:{{ .DB_PASSWORD }}@{{ .DB_HOST }}:{{ .DB_PORT }}/{{ .DB_NAME }}"

  # Data to fetch from secret manager
  data:
    - secretKey: DB_USER
      remoteRef:
        key: dmarc/production/database  # Path in AWS Secrets Manager
        property: username

    - secretKey: DB_PASSWORD
      remoteRef:
        key: dmarc/production/database
        property: password

    - secretKey: DB_HOST
      remoteRef:
        key: dmarc/production/database
        property: host

    - secretKey: DB_PORT
      remoteRef:
        key: dmarc/production/database
        property: port

    - secretKey: DB_NAME
      remoteRef:
        key: dmarc/production/database
        property: database
---
# ExternalSecret for Application Secrets
# JWT keys, API keys, etc.
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: dmarc-app-secrets
  namespace: dmarc
  labels:
    app.kubernetes.io/name: dmarc-dashboard
    app.kubernetes.io/component: backend
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore

  target:
    name: dmarc-app-secret
    creationPolicy: Owner

  data:
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: dmarc/production/app
        property: jwt_secret_key

    - secretKey: JWT_REFRESH_SECRET_KEY
      remoteRef:
        key: dmarc/production/app
        property: jwt_refresh_secret_key

    - secretKey: API_KEY
      remoteRef:
        key: dmarc/production/app
        property: api_key

    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: dmarc/production/redis
        property: password
---
# ExternalSecret for Email Configuration
# SMTP credentials for alert notifications
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: dmarc-email-credentials
  namespace: dmarc
  labels:
    app.kubernetes.io/name: dmarc-dashboard
    app.kubernetes.io/component: notifications
spec:
  refreshInterval: 1h

  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore

  target:
    name: dmarc-email-secret
    creationPolicy: Owner

  data:
    - secretKey: SMTP_SERVER
      remoteRef:
        key: dmarc/production/smtp
        property: server

    - secretKey: SMTP_PORT
      remoteRef:
        key: dmarc/production/smtp
        property: port

    - secretKey: SMTP_USERNAME
      remoteRef:
        key: dmarc/production/smtp
        property: username

    - secretKey: SMTP_PASSWORD
      remoteRef:
        key: dmarc/production/smtp
        property: password

    - secretKey: SMTP_FROM_EMAIL
      remoteRef:
        key: dmarc/production/smtp
        property: from_email
---
# ExternalSecret for Third-party API Keys
# MaxMind, OAuth providers, etc.
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: dmarc-third-party-keys
  namespace: dmarc
  labels:
    app.kubernetes.io/name: dmarc-dashboard
    app.kubernetes.io/component: integrations
spec:
  refreshInterval: 24h  # Less frequent refresh for stable keys

  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore

  target:
    name: dmarc-integrations-secret
    creationPolicy: Owner

  data:
    - secretKey: MAXMIND_LICENSE_KEY
      remoteRef:
        key: dmarc/production/integrations
        property: maxmind_license_key

    - secretKey: OAUTH_CLIENT_ID
      remoteRef:
        key: dmarc/production/oauth
        property: client_id

    - secretKey: OAUTH_CLIENT_SECRET
      remoteRef:
        key: dmarc/production/oauth
        property: client_secret

    - secretKey: SAML_PRIVATE_KEY
      remoteRef:
        key: dmarc/production/saml
        property: private_key
---
# ConfigMap with External Secrets usage instructions
apiVersion: v1
kind: ConfigMap
metadata:
  name: external-secrets-instructions
  namespace: dmarc
data:
  README.md: |
    # External Secrets Operator Setup

    ## Prerequisites

    1. Install External Secrets Operator:
       ```bash
       helm repo add external-secrets https://charts.external-secrets.io
       helm install external-secrets \
         external-secrets/external-secrets \
         -n external-secrets-system \
         --create-namespace
       ```

    2. Verify installation:
       ```bash
       kubectl get pods -n external-secrets-system
       ```

    ## Configuration Steps

    ### 1. AWS Secrets Manager

    a. Create secrets in AWS Secrets Manager:
       - dmarc/production/database (JSON with username, password, host, port, database)
       - dmarc/production/app (JSON with JWT keys, API keys)
       - dmarc/production/redis (JSON with password)
       - dmarc/production/smtp (JSON with SMTP credentials)
       - dmarc/production/integrations (JSON with third-party keys)

    b. Create IAM policy for secret access:
       ```json
       {
         "Version": "2012-10-17",
         "Statement": [
           {
             "Effect": "Allow",
             "Action": [
               "secretsmanager:GetSecretValue",
               "secretsmanager:DescribeSecret"
             ],
             "Resource": "arn:aws:secretsmanager:us-east-1:*:secret:dmarc/production/*"
           }
         ]
       }
       ```

    c. Attach IAM role to service account (EKS):
       ```bash
       eksctl create iamserviceaccount \
         --name dmarc-backend-sa \
         --namespace dmarc \
         --cluster your-cluster-name \
         --attach-policy-arn arn:aws:iam::ACCOUNT_ID:policy/DMARCSecretsPolicy \
         --approve
       ```

    ### 2. HashiCorp Vault

    a. Enable Kubernetes auth in Vault:
       ```bash
       vault auth enable kubernetes
       vault write auth/kubernetes/config \
         kubernetes_host=https://kubernetes.default.svc
       ```

    b. Create Vault policy:
       ```bash
       vault policy write dmarc-policy - <<EOF
       path "secret/data/dmarc/*" {
         capabilities = ["read"]
       }
       EOF
       ```

    c. Create Vault role:
       ```bash
       vault write auth/kubernetes/role/dmarc-role \
         bound_service_account_names=dmarc-backend-sa \
         bound_service_account_namespaces=dmarc \
         policies=dmarc-policy \
         ttl=24h
       ```

    ### 3. Google Cloud Secret Manager

    a. Create secrets in GCP Secret Manager
    b. Enable Workload Identity
    c. Bind service account to GCP service account

    ## Apply Configuration

    ```bash
    # Apply SecretStore/ClusterSecretStore
    kubectl apply -f external-secrets.yaml

    # Verify SecretStore
    kubectl get secretstore -n dmarc

    # Apply ExternalSecrets
    kubectl apply -f external-secrets.yaml

    # Verify ExternalSecrets
    kubectl get externalsecret -n dmarc
    kubectl describe externalsecret dmarc-database-credentials -n dmarc
    ```

    ## Verify Secret Synchronization

    ```bash
    # Check if secrets are created
    kubectl get secrets -n dmarc

    # Verify secret content (base64 decoded)
    kubectl get secret dmarc-db-secret -n dmarc -o jsonpath='{.data.DB_USER}' | base64 -d
    ```

    ## Troubleshooting

    ```bash
    # Check External Secrets Operator logs
    kubectl logs -n external-secrets-system deployment/external-secrets

    # Check ExternalSecret status
    kubectl describe externalsecret dmarc-app-secrets -n dmarc

    # Check SecretStore status
    kubectl describe secretstore aws-secrets-manager -n dmarc
    ```
